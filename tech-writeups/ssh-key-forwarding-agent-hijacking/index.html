<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anish - ssh-key-forwarding-agent-hijacking</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1e1e2e;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-link {
            color: #5bc0de;
            text-decoration: none;
            padding: 10px;
            display: block;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .back-link:hover {
            color: #ff6b6b;
            text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
        }

        .terminal-window {
            background: #2a2a3a;
            border: 2px solid #5bc0de;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 0 15px rgba(91, 192, 222, 0.2);
        }

        .terminal-header {
            background: #3a3a4a;
            padding: 10px;
            border-bottom: 1px solid #5bc0de;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal-dots {
            display: flex;
            gap: 5px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27ca3f; }

        .terminal-title {
            color: #a0a0a0;
            font-size: 14px;
        }

        .terminal-content {
            padding: 20px;
            padding: 20px 30px;
}

        .terminal-content pre {
            background: #1e1e2e;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .terminal-content code {
            font-family: 'Courier New', monospace;
        }

        .terminal-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .terminal-content th, .terminal-content td {
            border: 1px solid #5bc0de;
            padding: 10px;
            text-align: left;
        }

        .terminal-content th {
            background: #3a3a4a;
            color: #e0e0e0;
        }

        .terminal-content td {
            background: #2a2a3a;
        }

        .prompt {
            color: #5bc0de;
            margin-bottom: 10px;
        }

        .command {
            color: #ff6b6b;
        }

        h1 {
            color: #e0e0e0;
            font-weight: normal;
            text-shadow: 0 0 5px rgba(91, 192, 222, 0.3);
            font-size: 2.2em;
            text-align: center;
            margin-bottom: 20px;
        }

        h2, h3 {
            color: #e0e0e0;
            font-weight: normal;
            margin-bottom: 10px;
        }

        hr {
            border: 0;
            border-top: 1px solid #5bc0de;
            margin: 10px 0 20px 0;
            opacity: 0.5;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px rgba(91, 192, 222, 0.3); }
            to { text-shadow: 0 0 10px rgba(91, 192, 222, 0.5); }
        }

        .footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #5bc0de;
            margin-top: 50px;
            color: #a0a0a0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            
            .terminal-content {
                padding: 15px 20px;
            }

            .terminal-content ol {
                margin-left: 10px;
            }
}
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }

            h2, h3 {
                margin-bottom: 8px;
            }

            hr {
                margin: 8px 0 15px 0;
            }

            .terminal-content table {
                font-size: 0.9em;
            }
        }

        .matrix-char {
            position: absolute;
            color: #5bc0de;
            font-family: monospace;
            font-size: 14px;
            animation: matrix-fall linear infinite;
        }

        @keyframes matrix-fall {
            0% { opacity: 1; transform: translateY(-100vh); }
            100% { opacity: 0; transform: translateY(100vh); }
        }
    
        .terminal-content ol {
            margin-left: 15px;
        }

        .terminal-content ol li {
            margin-bottom: 10px;
        }
</style>
</head>
<body>
    <canvas class="matrix-bg" id="matrixCanvas"></canvas>

    <div class="container">
        <a href="https://anish7600.github.io/tech-writeups" class="back-link">← Back</a>
        
        <h1>ssh-key-forwarding-agent-hijacking</h1>
        <hr>

        <div class="terminal-window">
            <div class="terminal-header">
                <div class="terminal-dots">
                    <div class="dot red"></div>
                    <div class="dot yellow"></div>
                    <div class="dot green"></div>
                </div>
                <div class="terminal-title">~/technical-writeups/ssh-key-forwarding-agent-hijacking/index.sh</div>
            </div>
            <div class="terminal-content">
                <p><a href="https://anish7600.github.io/technical-writeups" style="text-decoration: none;">← Back</a></p>
<h3>SSH Key Forwarding and Agent Hijacking Risks</h3><hr>
<h4>Overview</h4>
<p>SSH (Secure Shell) is widely used for secure remote access and file transfers. One feature, <strong>SSH agent forwarding</strong>, allows users to access a remote server and then connect from that server to another system using their local private key—without copying the private key itself. While convenient, this feature introduces potential security vulnerabilities, particularly <strong>agent hijacking</strong>.</p>
<hr />
<h4>What is SSH Agent Forwarding?</h4>
<p>Normally, private SSH keys reside on the client machine. When you use <code>ssh -A user@host</code>, SSH forwards the authentication agent connection (typically a UNIX socket) to the remote server. This allows the remote host to request signing operations using your local private key, via your <code>ssh-agent</code>, without exposing the key.</p>
<p>This setup:</p>
<ul>
<li>Avoids copying keys to intermediate hosts.</li>
<li>Enables hop-based connections in trusted environments.</li>
</ul>
<p><strong>How it works:</strong></p>
<ul>
<li>The <code>ssh-agent</code> runs locally and manages private keys.</li>
<li>SSH forwards a Unix domain socket to the remote server.</li>
<li>The remote SSH client connects to this socket to authenticate to other machines.</li>
</ul>
<hr />
<h4>Agent Hijacking Explained</h4>
<p>If the remote host is compromised (or malicious), an attacker can:</p>
<ul>
<li><strong>Access the agent socket</strong> forwarded to it.</li>
<li><strong>Hijack the agent</strong> by making it sign authentication requests to other systems on your behalf.</li>
<li><strong>Move laterally</strong> through the network using your credentials.</li>
</ul>
<p>While the actual private key is not exposed, the attacker effectively <strong>gains access equivalent to owning your key</strong> for as long as the agent is forwarded and connected.</p>
<h5>Attack Scenario:</h5>
<ol>
<li>You SSH into a compromised server with <code>ssh -A</code>.</li>
<li>Attacker with access to the remote machine connects to the agent socket (e.g., <code>$SSH_AUTH_SOCK</code>).</li>
<li>They use your agent to authenticate to another machine where your key is trusted.</li>
<li>They pivot and compromise that machine.</li>
</ol>
<hr />
<h4>Mitigation Strategies</h4>
<ol>
<li>
<p><strong>Avoid Agent Forwarding</strong></p>
</li>
<li>
<p>Best practice: disable agent forwarding unless absolutely necessary.</p>
</li>
<li>
<p>Use ProxyJump (<code>-J</code>) instead of agent forwarding where possible.</p>
</li>
<li>
<p><strong>Use OpenSSH’s <code>ForwardAgent no</code> by default</strong></p>
</li>
<li>
<p>In <code>.ssh/config</code>:</p>
<p><code>ini
 Host *
   ForwardAgent no</code></p>
</li>
<li>
<p><strong>Use <code>ssh -o ForwardAgent=yes</code> only when needed</strong></p>
</li>
<li>
<p>Enable only for trusted hosts.</p>
</li>
<li>
<p><strong>Limit Lifetime of SSH Keys in the Agent</strong></p>
</li>
<li>
<p>Use key expiration or tools like <code>ssh-add -t 600</code> to limit key usage window.</p>
</li>
<li>
<p><strong>Use Hardware Tokens</strong></p>
</li>
<li>
<p>YubiKeys or smart cards prevent raw key export and require user interaction (e.g., touch confirmation).</p>
</li>
<li>
<p><strong>Restrict <code>AuthorizedKeys</code> Usage</strong></p>
</li>
<li>
<p>In <code>~/.ssh/authorized_keys</code>, use <code>from=</code> or <code>command=</code> to limit where and how keys can be used.</p>
</li>
<li>
<p><strong>Audit and Monitor Agent Usage</strong></p>
</li>
<li>
<p>Monitor for unexpected agent forwarding or multiple concurrent sign requests.</p>
</li>
</ol>
<hr />
<h4>Conclusion</h4>
<p>SSH agent forwarding offers convenience but also opens the door to serious security risks like agent hijacking, especially in untrusted or shared environments. A cautious approach—using jump hosts, disabling forwarding by default, and adopting hardware tokens—can greatly reduce the attack surface. When in doubt, assume that any host you SSH into may be compromised and act accordingly.</p>
            </div>
        </div>

        <div class="footer">
            <div class="prompt">root@writeup:~$ <span class="command">echo "End of transmission"</span></div>
            <p>&copy; 2025 Anish. All rights reserved.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Highlight.js
            hljs.highlightAll();

            const canvas = document.getElementById('matrixCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Canvas context not available');
                return;
            }

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*()_+-=[]{}|;:,.<>?';
            const charArray = chars.split('');
            const fontSize = 14;
            const columns = Math.floor(canvas.width / fontSize);
            const drops = Array(columns).fill(1);

            function draw() {
                ctx.fillStyle = 'rgba(30, 30, 46, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#5bc0de';
                ctx.font = `${fontSize}px monospace`;

                for (let i = 0; i < drops.length; i++) {
                    const text = charArray[Math.floor(Math.random() * charArray.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            setInterval(draw, 35);

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        });
    </script>
</body>
</html>
